name: Build, publish & attest (SBOM + provenance)

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*' ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  id-token: write

env:
  IMAGE: ghcr.io/${{ github.repository_owner }}/rdw-api

jobs:
  build-and-attest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image (multi-arch) (buildx with SBOM & provenance)
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --file ./Dockerfile \
            --tag ${{ env.IMAGE }}:${{ github.sha }} \
            --tag ${{ env.IMAGE }}:latest \
            --push \
            --sbom=true \
            --provenance=true \
            .

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.IMAGE }}:${{ github.sha }}
          output: cyclonedx-json
          output-file: sbom.cdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.cdx.json

      - name: Attach SBOM to image (OCI artifact)
        uses: sigstore/cosign-action@v2
        env:
          COSIGN_EXPERIMENTAL: "1"
        with:
          args: attach sbom --sbom sbom.cdx.json ${{ env.IMAGE }}:${{ github.sha }}

      - name: Create provenance predicate
        run: |
          cat >predicate.json <<'EOF'
          {
            "buildType": "https://github.com/slsa-framework/slsa-github-generator",
            "builder": { "id": "https://github.com/${{ github.repository }}" },
            "invocation": {
              "configSource": {
                "type": "git",
                "uri": "https://github.com/${{ github.repository }}",
                "ref": "${{ github.ref }}",
                "digest": { "sha1": "${{ github.sha }}" }
              }
            },
            "metadata": {
              "buildStartedOn": "${{ github.event.head_commit.timestamp || format('now','%Y-%m-%dT%H:%M:%SZ') }}",
              "completeness": { "environment": true, "materials": true, "parameters": true }
            },
            "materials": [
              { "uri": "git+https://github.com/${{ github.repository }}@${{ github.sha }}" }
            ]
          }
          EOF

      - name: Attest provenance (keyless via OIDC)
        uses: sigstore/cosign-action@v2
        env:
          COSIGN_EXPERIMENTAL: "1"
        with:
          args: attest --type in-toto --predicate predicate.json ${{ env.IMAGE }}:${{ github.sha }}

      - name: Upload provenance predicate
        uses: actions/upload-artifact@v4
        with:
          name: provenance
          path: predicate.json

      - name: Quick verification (attestation exists)
        uses: sigstore/cosign-action@v2
        with:
          args: verify-attestation --type in-toto ${{ env.IMAGE }}:${{ github.sha }}
